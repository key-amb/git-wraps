#!/usr/bin/env bash

set -euo pipefail

# Option variables
PULL=${PULL:-}
INTERACTIVE=${INTERACTIVE:-}
VERBOSE=${VERBOSE:-}
GIT_BRANCH_CLEAN_WHITELIST=${GIT_BRANCH_CLEAN_WHITELIST:-}

help() {
  pod2text $0
  exit 1
}

# ============================================================
# Parse Arguments

for opt in "$@"; do
  case "$opt" in
    "-i" ) INTERACTIVE=on ;;
    "-p" | "--pull"    ) PULL=on ;;
    "-v" | "--verbose" ) VERBOSE=on ;;
    "-h" | "--help"    ) help ;;
    * ) ;;
  esac
done

if [[ -z "${GIT_BRANCH_CLEAN_WHITELIST}" ]]; then
  GIT_BRANCH_CLEAN_WHITELIST=(master develop)
fi

# working branch
current=$(git rev-parse --abbrev-ref HEAD)
GIT_BRANCH_CLEAN_WHITELIST+=($current)

if [[ -n "${PULL}" ]]; then
  git pull --prune
fi

for br in $(git branch --format="%(refname:short)" --merged); do
  for _br in ${GIT_BRANCH_CLEAN_WHITELIST[@]}; do
    if [[ "$br" = "$_br" ]]; then
      if [[ -n "$VERBOSE" ]]; then
        echo "Branch \"${_br}\" is whitelisted. Skip."
      fi
      continue 2
    fi
  done
  if [[ -n "${INTERACTIVE}" ]]; then
    echo -n "Delete ${br} ? (y/N) "
    read answer
    if [[ "$answer" != "y" ]]; then
      echo "Canceled."
      continue
    fi
  fi
  git branch -d $br
done

exit

: <<'__EOF__'

=encoding utf8

=head1 NAME

B<git-branch-clean> - git subcommand to clean up merged local branches

=head1 SYNOPSYS

    git branch-clean [OPTIONS]

=head1 DESCRIPTION

git subcommand to clean up merged local branches

=head1 OPTIONS

=over

=item B<-i>

Interactive mode. Show prompt before deleting branch.

=item B<-p|--pull>

Execute C<git pull --prune> before deleting branches.

=item B<-v|--verbose>

Verbose output.

=item B<-h|--help>

Show help text.

=back

=head1 AUTHORS

IKEDA Kiyoshi E<lt>progrhyme@gmail.comE<gt>

=head1 LICENSE

The MIT License (MIT)

Copyright (c) 2020 IKEDA Kiyoshi

=cut

__EOF__
